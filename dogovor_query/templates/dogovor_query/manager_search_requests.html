{% extends 'specialist/specialist_topbar.html' %}
{% load static %}
{% block title %}
    Заявки | Договорный отдел СПбГУТ
{% endblock %}
{% block content %}
    <div class="container mt-3">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-
                    {% if message.level_tag != 'error' %}{{ message.level_tag }}{% else %}danger{% endif %} m-2"
                     role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        <div class="card m-3">
            <div class="card-body">
                <input type="hidden" id="current_search_user_pk" value="{{ client.pk }}"/>
                <form method="POST" id="form_search">
                    {% csrf_token %}
                    <div class="input-group">
                        {{ form.user }}
                        <div class="input-group-append">
                            <button class="btn btn-outline-primary" type="submit" id="button_search">Поиск</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% if requests %}
            <div id="requests_collapse">
                {% for request in requests %}
                    <div class="card m-3">
                        <div class="card-header">
                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                    data-target="#collapse{{ request.pk }}"
                                    aria-expanded="true" aria-controls="collapse{{ request.pk }}">
                                Заявка {{ request.get_query_number }} от {{ request.created_at }} |
                                {{ request.question }} |
                                {% for log in request.requestlog_set.all %}
                                    {% if forloop.last %}
                                        {% if log.status == 'created' %}
                                            <span class="text-warning">{{ log.get_status_verbose }}</span>
                                        {% elif log.status == 'activated' %}
                                            <span class="text-success">{{ log.get_status_verbose }}</span>
                                        {% elif log.status == 'processing' %}
                                            <span class="text-info">{{ log.get_status_verbose }}</span>
                                        {% elif log.status in 'closedcancelled' %}
                                            <span class="text-danger">{{ log.get_status_verbose }}</span>
                                        {% elif log.status == 'postponed' %}
                                            <span class="text-dark">{{ log.get_status_verbose }}</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </button>
                        </div>
                        <div id="collapse{{ request.pk }}" class="collapse"
                             aria-labelledby="heading{{ request.pk }}" data-parent="#requests_collapse">
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">Тип: {{ request.get_type_verbose }}</li>
                                    <li class="list-group-item">Тема: {{ request.question }}</li>
                                    <li class="list-group-item">Примечания:
                                        {% if request.note_set.all %}
                                            <table class="table table-hover table-sm mt-2">
                                                {% for note in request.note_set.all %}
                                                    <tr>
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>{{ note.text }}</td>
                                                        <td>{{ note.created_at }}</td>
                                                        <td>{{ note.specialist.get_short_name }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </table>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </li>
                                    <li class="list-group-item">История изменений:
                                        <table class="table table-hover table-sm mt-2">
                                            {% for log in request.requestlog_set.all %}
                                                <tr>
                                                    <td>{{ forloop.counter }}</td>
                                                    <td>{{ log.get_status_verbose }}</td>
                                                    <td>{{ log.created_at }}</td>
                                                    <td>{{ log.specialist.get_short_name }}</td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block additional_js %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="{% static 'dogovor_query/manager_search.js' %}"></script>
{% endblock %}
{% block additional_css %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet"/>
    <link href="{% static 'dogovor_query/select2-bootstrap4.css' %}" rel="stylesheet"/>
{% endblock %}